# Что не так с сорсмапами и как с ними не связываться

[Открыть в интерфейсе проведения презентаций.](https://nin-jin.github.io/slides/sourcemap/)

## Зачем? Без DSL один бойлерплейт

> *пример dsl и сгенеренного кода*

## Зачем? Пользовательские скрипты

> *пример скрипта*

## JS в песочница?!?

- Да, это возможно: [sandbox.js.hyoo.ru](https://sandbox.js.hyoo.ru)
- JS слишком сложный

## Зачем? Фатальный недостаток

- Какой программист не хочет свой язык?

## Зачем? Транспиляция

- Babel и прочие транспайлеры
- Uglify и прочие минификаторы
- TypeScrit, AssemblyScript и прочие ЯП
- SCSS, Less, Stylus PostCSS и прочие CSS генераторы
- SVGO, CSSO и прочие оптимизаторы
- JSX, Pug, Handlebars и прочие шаблонизаторы
- MD, TeX и прочие языки разметки

## Зачем? Проверки при сборке

- TypeScript, FlowJS, Hegel и прочие тайпчекеры
- ESLint и прочие линтеры
- Pretier и прочие форматтеры

## Проблемы? Это не то, что я написал!

> *пример исходника и результата*

## Проблемы? Да тут чёрт ногу сломит!

> *пример сложного (минифицированного?) сгенерированного кода*

## Сорсмапы спешат на помощь! Исходники

> *скрин из девтулзов*

## Сорсмапы спешат на помощь! Отладчик

> *скрин с брейкпоинтом в VSCode*

## Сорсмапы спешат на помощь! Стек трейсы

> *скрин до и после загрузки сорсмап*

## Сорсмапы спешат на помощь! Переменные

> *скрин со значением переменной при наведении*

## Как работают сорсмапы

- Нужен исходник/стектрейс
- Скачиваем совсмап
- Налету подменяем

## История сорсмапов

- V1 - Internal Closure Inspector format
- [Proposal V2 2010](https://docs.google.com/document/d/1xi12LrcqjqIHTtZzrzZKmQ3lbTv9mKrN076UB-j3UZQ/edit?hl=en_US) +JSON -20%
- [Proposal V3 2013](https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k/edit) - 50%

## Крупицы информации

- [Introduction to JavaScript Source Maps](https://www.html5rocks.com/en/tutorials/developertools/sourcemaps/)

## Как подключаются

HTTP заголовком:

    SourceMap: <url>

В конце JS:

    //# sourceMappingURL=<url>

В конце CSS:

    /*# sourceMappingURL=<url> */

# Формат сорсмапов

# Проблемы формата

# Пробуем генерить руками

- звиздец сложно
- носиться с ними во всех трансформациях
- носиться с ними в сообщениеях об ошибках

# Чёт сложно, нужна абстракция

# храним координаты в ast

# новые узлы создаём на базе существующих

# пайплайн

- загрузили аст
- трансфрмировали и почекали
- сериализовали в скрипты/стили и сорсмапы

# Хороший тон

- Укзывать на исходник, а не шаблон
- Генерить инструкции, а не выражения
- Прикладывать исходник

# Отладка трансформаций: Дамп AST

- [`foo = { bar: 123 }`](https://astexplorer.net/#/gist/1296170ba2b75ef8f70acb6c478a8215/9eb19231aca08d65d1048919670839dc04469e63)

```json
{
  "type": "Program",
  "sourceType": "script",
  "body": [
    {
      "type": "ExpressionStatement",
      "expression": {
        "type": "AssignmentExpression",
        "left": {
          "type": "Identifier",
          "name": "foo"
        },
        "operator": "=",
        "right": {
          "type": "ObjectExpression",
          "properties": [
	    ...
```

# Отладка трансформаций: Наглядный дамп

```javascript
foo = { bar: 123 }
```

```tree
{;}
	=
		foo
		{,}
			:
				\bar
				123
```

```javascript
{
	foo = {
		"bar": 123,
	};
}
```

# песочница трансформаций

# пилим свой dsl сразу на ast

- самый простой путь
- синтаксис специфический

# jack.tree - макро язык

# хотим совсем свой синтаксис

- парсим в аст

# не только скрипты

- стили
- хтмл
- что угодно

# меняем таргеты налету (js/wasm?)

# даже wasm с сорсмапингом?!

# LS для IDE

- Привязка структур к узлам аст

# Подсветка синтаксиса

- для tree уже есть но можно сделать кастомизируемую
- для своего языка через парсинг в tree

