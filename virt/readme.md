# Автоматическая виртуализация рендеринга произвольной вёрстки

Здравствуйте, меня зовут дмитрий Карловский и я.. каждый день делаю это.. виртуализирование интерфейсы. Я делал иерархические списки задач на 40К штук, редактор документов на 200 страниц, и даже запилил фреймворк, где виртуализация происходит автоматически. Короче, съел я на той теме собаку, кошку, хорька, енота и даже морскую свинку. Так что далее я расскажу как эффективно предоставлять пользователю огромные объёмы данных, почему вообще возникает такая необходимость, какие технологии нам с этим могут помочь, и почему Реакт не способен избавить нас от головной боли.

[Дмитрий Карловский @ HolyJS'20 Moscow](https://holyjs-moscow.ru/)

Вы можете либо [посмотреть видео запись](), либо [открыть в интерфейсе проведения презентаций](https://nin-jin.github.io/slides/virt/), либо [читать как статью](https://github.com/nin-jin/slides/blob/master/virt/readme.md)...

## Типичный цикл разработки

- Написали код
- Проверили в типличных условиях
- Пришли пользователи и всё заспамили

## Наивный рендеринг

- Медленная загрузка
- Жрём много памяти
- Плохая отзывчивость

## Оптимизации

- Упрощение вёрстки - асимптотика не меняется
- Виртуализация - ручные приседания
- Вирт-фреймворк - то, что надо

## Ручные оптимизации

- Пагинация
- Экспандеры
- Бесконечный скролл
- Вирт скролл

## Автоматические оптимизации

- Тайм слайсинг
- Прогрессивный рендеринг
- Ленивый рендеринг
- Виртуальный рендеринг

## Проблемы виртуализации

- Оценка будущих размеров
- Скачки контента
- Скачки скроллбара
- Перерисовка всего экрана
- Прокрутка к элементу
- Поиск по странице

## Scroll Anchoring

- как работает
- как использовать
- где работает
- что делать, если не работает

### Подавление Scroll Anchoring

- top, left, right, bottom
- margin, padding
- Any width or height-related properties
- transform
- scroll-anchor: none

## Оценка размеров

- Точная
- Минимальная
- Максимальная
- Усреднённая
- Последняя

## Когда обновляться

- onScroll
- IntersectionObserver
- requestAnimationFrame

## Долгая раскладка

```
contain: content // for scroller
transform: translateZ(0) // for it's content
```

## Составные компоненты

- Вертикальный список
- Горизонтальный список
- Стек наложения
- Горизонтальный список с переносами

## Объекты против функций

- Объект: одно состояние - много действий
- Функция: много состояний - одно действие

## Ортогональные ручки

- Узнать минимальные размеры
- Частично отрендерить содержимое
- Проверить соответствие поисковому запросу

## Логика рендеринга

- Измеряем положение
- Опрашиваем минимальные размеры
- Измеряем сколько куда нужно дорендерить
- Добавляем/удаляем элементы
- Для вложенных компонент повторяем рекурсивно

## Логика прокрутки

- Рекурсивно спускаемся по компонентам
- Форсируем рендерингпо пути до найденного
- Отложенно вызываем scrollIntoView на дом узле

## Логика поиска

*подумать*

## Демонстрация

![HabrComment](https://nin-jin.github.io/habrcomment/#article=423889)

## Бенчмарки

- скорость открытия
- отзывчивость
- потребление памяти

## Фундаментальные особенности

- Скачки скроллбара при неточной оценке размеров
- Scroll Anchoring может не работать в некоторых контекстах.

