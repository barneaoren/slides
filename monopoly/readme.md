# Фрактальные моно-поли-репозитории

Организуем кодовую базу так, чтобы она легко и плавно масштабировалась от одной библиотеки, поддерживаемой одним человеком, до фрактальной экосистемы библиотек и приложений, поддерживаемой кучей команд из разных компаний.

# Типичный путь развития проекта

## Поли-репо

- Каждая библиотека в своём репозитории.
- Изменил зависимость - изволь опубликовать и обновить версии в зависимых.
- Зависимость от инфраструктуры при локальной разработке.
- Пуш в поли-репо не атомарен.

## Моно-репо

- Все библиотеки сваливаются в кучу в один репозиторий.
- Пуш всегда атомарен.
- Разработчики толкаются локтями, работая с одним репо.
- Трудности с разграничением прав доступа.
- Трудности с бранчеванием одной библиотеки без влияния на другие.
- Не помещается на локальной машине целиком - нужен спец тулинг.

## Мульти-моно-репо

- Каждой команде свой моно-репо.
- Работаешь и там, и там - получаешь проблемы поли-репо.
- С бранчеванием проблемы остаются.
- Пуш сноова не атомарен.

## Что не так с этим путём?

- Каждый переход - большая работа по изменению кода и тулинга.
- Решаются одни проблемы - открываются другие.
- Решаются другие - открываются первые.

# Моно-поли-репо

- Изначально репо одно.
- Директория разрослась - в отдельный репо.
- Рекурсивная декомпозиция порождает дерево репо.
- Сам код остаётся неизменным.
- Локальная разработка не зависит от инфраструктуры.
- Не засоряется реестр пакетов промежуточными версиями.
- Не фиксируются версии.
- Простой тулинг.

## Композиция

- Клонирование по необходимости.
- В каждом репо - реестр вложенных репо.
- В корневом репо - никакого кода.

- `git submodules` - фикс ревизии
- `git merge-tree` - фикс ревизии
- `git clone | hg clone` - последняя ревизия

## Отделение кода от рабочего окружения

- Настройки рабочего окружения - отдельное репо.
- В рамках одного окружения работа со множеством проектов.
- Настройки тулинга едины - приходят в корневом репо.
- Централизованный рефакторинг всех репо.

# Версионирование

## SemVer

- Версия фиксируется по некоторому правилу.
- Минорные версии тоже могут всё сломать.
- Нельзя использовать сразу несколько версий.
- Нет гарантий, что использована единая версия.
- Нельзя выразить одну версию через другую.
- Лок файлы для библиотек бесполезны.
- Фрагментация экосистемы по версиям.

## VerLess

- Версии не фиксируются.
- Везде и всеми используется единая версия - последняя.
- Непрерывная интеграция актуальных версий.
- Изменения API - новый модуль, а не версия старого.
- Старый модуль может быть выражен через новый.

# Безопасность

| | SemVer | VerLess
|-|--------|--------
| Диверсии | случаются (нужны тесты) | случаются (нужны тесты)
| Фиксы безопасности | могут долго буксовать | уже при следующем релизе

# Моно-поли-репо в дикой природе

- [MAM: сборка фронтенда без боли]( https://habhub.hyoo.ru/#!author=nin-jin/repo=HabHub/article=18) - наш девтул.
- [$hyoo](https://github.com/orgs/hyoo-ru/repositories?type=all) - наш моно-поли-репо.
- [$psb_portal](https://github.com/MolDevHack) - пример фрактального микрофронтенда.
- [Фрактальное тестирование](https://github.com/nin-jin/slides/tree/master/testing) - выступление на TechLeadConf.

# Больше информации

- [SemVer-vs-VerLess](https://github.com/hyoo-ru/mam_mol/wiki/SemVer-vs-VerLess) - про версионирование.

---

- Добавить проблемы с зависимостями какие встретили и как они решаются.
- Глянуть, что намутили в го-модулях.