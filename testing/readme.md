# Вращая рожок тестирования

Здравствуйте, меня зовут Дмитрий Карловский и я.. люблю гнять всякую странную дичь. Осторожно, после этого доклада у вас может появиться странное желание удалить все модульные и e2e тесты из вашего проекта.

![](https://habrastorage.org/webt/ib/cz/-8/ibcz-8oemwznh7e6vkfm2g5ly18.png)

Это расшифровка выступления на TechLead Conf 2020. Вы можете [читать её как статью](https://github.com/nin-jin/slides/tree/master/testing), а можете [открыть в интерфейсе проведения презентаций](https://nin-jin.github.io/slides/testing/).

# О себе

- В программировании уже 25 лет
- Большие и маленькие проекты
- Последние 15 лет в основном фронт, но не только
- Разработал фреймворк будущего
- Сейчас пилю крутую штуку для 1С

# Путь в тестировании

- Не писал тесты
- Избегал тесты
- Без тестировщиков пришлось разбираться самому
- Набил кучу шишек
- Понял как правильно тестировать
- Хочу поделиться с вами

# Зачем тесты? Оперативная обратная связь!

![](https://habrastorage.org/webt/cc/ri/dx/ccridxneeqhxo83qiy_jb5smgl8.png)

Чем раньше поставить тесты, чем короче цикл отладки и меньше негатива от сопричастных. А чем меньше цек, тем он быстрее, а значит быстрее поставляются новые фичи.

# Зачем тесты? Ускорение написания кода!

- Тест в любом случае придётся написать
- Но перезапускать его быстрее, чем проверять руками

# Зачем тесты? Локализация дефектов!

![](https://habrastorage.org/webt/7w/py/3c/7wpy3caqtdd65bwkifphjesudny.png)

Хороший тест указывает на конкретное проблемное место.

# Зачем тесты? Актуальная документация!

- Отдельная документация всегда врёт
- Даже если это комментарий рядом с кодом

Рассказать про тесты встроенные в язык D.

# Идеальные тесты: фиксируют лишь внешнее поведение

Проверяют всё важное, но не фиксируют неважное

![](https://habrastorage.org/webt/lx/46/eg/lx46eg3hn41waztjepmpxurlac4.png)

# Идеальные тесты: баланс между числом и охватом

Минимальное число, но охватывают все сценарии

![](https://habrastorage.org/webt/n2/sg/og/n2sgogzjpousryqbpj7mleel0mq.png)

# Идеальные тесты: быстро и просто

Исполняются быстро, а писать просто

![](https://habrastorage.org/webt/ud/2d/26/ud2d26qrwzgfptloqlapax5odsw.png)

# Термины

- Нет чётких определений
- Разные вещи называются одним именем
- Одно и то же называется разными именами

Нам надо синхронизироваться

# Система (приложение)

Система - едница развёртывания, ваш продукт. E2E, системное тестирование.

![](https://habrastorage.org/webt/h9/pe/t4/h9pet4ua862thaq9-ugcg8wmlnw.png)

# Модуль (юнит)

Модуль - единица кода. Модульное тестирование.

![](https://habrastorage.org/webt/ip/6-/my/ip6-my7poauwvga0n3iswxieqvs.png)

# Компонент (подсистема)

Компонент - единица функциональности. Компонентное тестирование.

![](https://habrastorage.org/webt/wk/ze/xb/wkzexblhbsx5vxtadfz-rjenrgq.png)

# Рожок тестирования

![](https://habrastorage.org/webt/xe/b_/uv/xeb_uvl9tnppqs80w5fz-qaxqc4.png)

Рассказывая про типы тестирования, оыбчно показывают рожок, мол мало времени тратится на модульные тесты, но много на ручные.

# Пирамида тестирования

Топят за то, чобы минимизировать долгое и сложное тестирование, и максимизировать простое и быстрое.

![](https://habrastorage.org/webt/r-/mw/nu/r-mwnurad5al7wuyh1rfevttqhw.png)

# Рюмка тестирования

![](https://habrastorage.org/webt/sp/cv/s6/spcvs6epo2odp4cnzbj9mnpodcc.png)

Разработчики пишут модульные тесты.
Интеграционные писать сложно и не понятно как.
Приёмочное/регрессионное ручное тестирование при релизе.
Автотестеры с сильной задержкой пишут системные тесты.

# Модульные тесты - ломают абстракции

```typescript
 // No way! It's hard to mock!
 const three = summ( 1 , 2 )


// Yeah! It's enterprise, baby!
const summator = new Summator( algebra , logger , allocator )
const three = summator.summ( 1 , 2 )
```

# Модульные тесты - хрупкие

![](https://habrastorage.org/webt/3z/q0/s9/3zq0s9wyk80afji56vlwfsxyhqy.png)

# Критерии бесполезности теста

- Желаемое поведение не изменилось
- Тест упал

- Желаемое поведение изменилось
- Тест не упал

# Модульные тесты - не полны

Чем меньше и проще модули, тем более важно их взаимодействие. 2х тестов.

![](https://habrastorage.org/webt/iz/wm/ee/izwmeechwa5ptk7swidli8rt2qu.png)

# Системные тесты - не масштабируются

![](https://anekdotsuper.ru/assets/img/cvety/aero-1.jpg)

Так, эту кнопку протестировали, сажаем самолёт.

# Системные тесты - хрупкие

![](https://habrastorage.org/webt/mg/sl/ja/mgsljah190qhsh-dhcdzhjj7gpq.png)

Чуть поправил и все тесты посыпались.

# Интеграционные тесты: Медленно

![](https://habrastorage.org/webt/d1/sn/fn/d1snfnhjxmkhr5rsfatgroahmfu.png)

TestBed в ангуляре давал 100мс на тест, или уже 5 сек на 50 тестах. Приходилось запускать тесты отдельно.

# Интеграционные тесты: Быстро

1. "Ленивая" архитектура приложения
2. Быстрый старт тестов

Например, мы выпилили инициализацию TestBed для каждого теста - ускорение на порядок.

# Компонентные тесты: Подстраховка

![](https://habrastorage.org/webt/jb/9a/4a/jb9a4aponmju_rvamak6urk-n_u.png)

Елси зависимость плохо протестирована зависимых поймает ошибку. Придётся поискать её, но это лучше, чем вообще её ропустить.

# Компонентные тесты: Где ошибка?

![](https://habrastorage.org/webt/43/is/-0/43is-0bbn4avjzlnvo6qpbbmjpe.png)

Часто запускаются в поизвольном порядке. Из-за чего ошибка в глубине роняет высокоуровневый компонент и приходится долго испкать сбойный модуль.

# Фрактальное тестирование

![](https://habrastorage.org/webt/ze/ry/ck/zeryckshafly7bvux2c8vy-rs6c.png)

Фактически это правильная организация компонентных тестов.

# Фрактальное тестирование: Вот ошибка!

Запуск в порядке от зависимостей к зависимым позволяет по первому упавшему тесты понять где проблема. Остальные тесты можно уже и не исполнять.

![](https://habrastorage.org/webt/zb/ei/b2/zbeib2cwtnocfgsu5kl0btbebw4.png)

MAM - сборщик яваскрипта, где тесты и стили выстраиваются в том же порядке, что и код в бандле.

# Фрактальное тестирование: Кратчайший путь

![](https://habrastorage.org/webt/cx/ap/or/cxaporyvfvkzul0w_tuchgg_sau.png)

При изменении исполнять лишь зависимые тесты в правильном порядке, а не все подряд.

# Фрактальное тестирование: Постоянная сложность

![](https://habrastorage.org/webt/4u/s4/03/4us403dc4-r1zyc956wf334bj2w.png)

Каждый уровень добавляет примерно одинаковое число тестов.

# Фрактальное тестирование: Простота написания

Просто используем компоненты как в реальном коде.

```typescript
const app = new Todomvc({ context })

const title = guid()
const rowsPrev = app.rows()

app.NewTitle().value( title )
app.NewSubmit().click()

const rowNew = app.rows()[0]

assertEqual( app.rows() , [ rowNew , ... rowsPrev ] )
assertEqual( rowNew.title() , title )
assertEqual( app.NewTitle().value() , '' )
```

# Фрактальное тестирование: Уровни изоляции

1. На проде 
2. На тестовом сервере
3. Без сервера в разных браузерах
4. Без браузера под Нодой

# Фрактальное тестирование: Качество

- Тестируются все модули
- Тестируются все взаимосвязи
- На каждом уровне есть все необходимые ручки
- В том числе и вся система в сборе
- В том числе в разных окружениях.

# Фрактальное тестирование: Простая поддержка

- Компонентных тестов столько же сколько модульных
- Скорость исполнения сравнима с модульными
- Падают лишь при изменении значимого поведения

# Близость к идеалу

| **Критерий**             | **Достигнут?** |
|----------------------|-----|
| Фиксируют лишь внешнее поведение | ✅ |
| Баланс между числом и охватом | ✅ |
| Писать быстро и просто | ✅* |

Хватит вращать рожок тестирования, его нужно просто выбросить, и писать компонентные тесты во фрактальном стиле.

# Мой проект

- Пилю соло второй год
- Сложный web-виджет
- Рефакторинг несколько раз в месяц
- 300 тестов за пол секунды
- Старт при перезагрузке страницы
- Им пользуется мой руководитель

Пишу тесты ибо это нужно прежде всего мне самому. Но стараюсь писать их так, чтобы тратить минимум усилий.

# Опыт других людей

- [PiterJS#44: Если нужен тест, пусть он будет интеграционным](https://piterjs.org/#meetup=44/speech=should-test-be-integrational) @ Василий Малыхин
- [Is TDD Dead?: My personal practice is that I mock almost nothing](https://youtu.be/z9quxZsLcfo) @ Kent Beck

# Ограничения фрактального тестирования

- Монолитная архитектура
- Тяжёлая архитектура
- Отсутствие инверсии контроля

# Хочется большего?

- [nin-jin/slides](https://github.com/nin-jin/slides) - мои выступления
- [habhub.hyoo.ru](https://habhub.hyoo.ru/) - мои статьи
- [_jin_nin_](https://twitter.com/_jin_nin_) - мои заметки
- [nin_jin](https://teleg.run/nin_jin) - связь со мной
