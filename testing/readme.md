# Вращая рожок тестирования

> Дмитрий Карловский @ Где-то Когда-то

Вы можете [читать её как статью](https://github.com/nin-jin/slides/tree/master/testing), а можете [открыть в интерфейсе проведения презентаций](https://nin-jin.github.io/slides/testing/).

# О себе

- В программировании уже 25 лет
- Большие и маленькие проекты
- Последние 15 лет в основном фронт, но не только
- Разработал фреймворк будущего
- Сейчас пилю крутую штуку для 1С

# Будни разработчика

- Баги
- Деньги
- Сроки
- Менеджеры

# Борьба с багами

- Пиши без багов! (с) Наивный Тимлид
- Поднять отряд ручных тестировщиц! (c) Типичный Менеджер
- Опишем всё типами! (с) Читатель Хабра
- Кажется нам нужны тесты.. (с) Безысходность

# Путь в тестировании

- Не писал тесты
- Избегал тесты
- Без тестировщиков пришлось разбираться самому
- Набил кучу шишек
- Понял как правильно тестировать
- Хочу поделиться с вами

# Зачем тесты? Уменьшение цикла тестирования!

![](https://habrastorage.org/webt/rw/ch/p9/rwchp9axrbg9_hqgwj6p3-3ijki.png)

Чем раньше поставить тесты, чем короче цикл отладки и меньше негатива от сопричастных. А чем меньше цек, тем он быстрее, а значит быстрее поставляются новые фичи.

# Зачем тесты? Ускорение разработки!

- Тест в любом случае придётся написать
- Но перезапускать его быстрее, чем проверять руками

# Зачем тесты? Локализация дефектов!

![](https://habrastorage.org/webt/yh/tj/l3/yhtjl39oi0n03q6eqdvgopw-wey.png)

Хороший тест указывает на конкретное проблемное место.

# Зачем тесты? Актуальная документация!

- Отдельная документация всегда врёт
- Даже если это комментарий рядом с кодом

Рассказать про тесты встроенные в язык D.

# Идеальные тесты

- Проверяют всё важное
- Не фиксируют неважное
- Минимальное число
- Охватывают все сценарии
- Исполняются быстро
- Писать просто

# Термины

- Нет чётких определений
- Разные вещи называются одним именем
- Одно и то же называется разными именами
- Нам надо синхронизироваться

# Система (приложение)

Система - едница развёртывания, ваш продукт. E2E, системное тестирование.

![Система](https://habrastorage.org/webt/2l/pj/7z/2lpj7ziss3wkfogjqpp_7y8oo5u.png)

# Модуль (юнит)

Модуль - единица кода. Модульное тестирование.

![Модули](https://habrastorage.org/webt/j5/lo/c0/j5loc0fpww-tsxydb_exrpr0ymk.png)

# Компонент (подсистема)

Компонент - единица функциональности. Компонентное тестирование.

![Компоненты](https://habrastorage.org/webt/zt/r-/ch/ztr-ch87u4jfaiwt4ixcmtukzfq.png)

# Рожок тестирования

![](https://habrastorage.org/webt/xe/b_/uv/xeb_uvl9tnppqs80w5fz-qaxqc4.png)

Рассказывая про типы тестирования, оыбчно показывают рожок, мол мало времени тратится на модульные тесты, но много на ручные.

# Пирамида тестирования

Топят за то, чобы минимизировать долгое и сложное тестирование, и максимизировать простое и быстрое.

![](https://habrastorage.org/webt/r-/mw/nu/r-mwnurad5al7wuyh1rfevttqhw.png)

# Стопка тестирования

![](https://habrastorage.org/webt/sp/cv/s6/spcvs6epo2odp4cnzbj9mnpodcc.png)

Разработчики пишут модульные тесты.
Интеграционные писать сложно и не понятно как.
Приёмочное/регрессионное ручное тестирование при релизе.
Автотестеры с сильной задержкой пишут системные тесты.

# Модульные тесты - ломают абстракции

> *Модуль А зависит от модуля Б.*
> *Зависимость от Б выносится в публичный интерфейс.*
> *Часто это знание навязывается через конструктор.*

# Модульные тесты - хрупкие

> *Модуль А зависит от модуля Б.*
> *Изменили протокол их взаимодействия, не меняя внешнего поведения А.*
> *Сломались тесты А и Б.*

# Критерий бесполезности теста

- Поведение системы не изменилось
- А тесты упали

# Модульные тесты - не полны

Чем меньше и проще модули, тем более важно их взаимодействие. 2х тестов.

![Тестирование взаимодействия](https://habrastorage.org/webt/r_/kh/ml/r_khmlkalzxp9cys-e1vg_dws3u.png)

# Системные тесты не масштабируются

> *Тестрование самолёта в сборе, чтобы проверить, что шуруп подходит к гайке.*

# Интеграционные тесты: Где ошибка?

Часто запускаются в поизвольном порядке. Из-за чего ошибка в глубине роняет высокоуровневый компонент и приходится долго испкать сбойный модуль.

# Интеграционные тесты: Медленно

*TestBed в ангуляре давал 100мс на тест, или уже 5 сек на 50 тестах. Приходилось запускать тесты отдельно.*

# Интеграционные тесты: Быстро

1. Ленивая архитектура приложения
2. Быстрый старт тестов

Например, мы выпилили инициализацию TestBed для каждого теста - ускорение на порядок.

# Фрактальное тестирование

![](https://habrastorage.org/webt/om/js/qs/omjsqs79zvpvmtejh0vprxj14tm.png)

Фактически это правильная организация компонентных тестов.

# Фрактальное тестирование: Подстраховка

![](https://habrastorage.org/webt/wd/n7/jd/wdn7jdywjwqsypof2g3d9hwfkt4.png)

Елси зависимость плохо протестирована зависимых поймает ошибку. Придётся поискать её, но это лучше, чем вообще её ропустить.

# Фрактальное тестирование: Вот ошибка!

Запуск в порядке от зависимостей к зависимым позволяет по первому упавшему тесты понять где проблема. Остальные тесты можно уже и не исполнять.

![Порядок исполнения тестов](https://habrastorage.org/webt/jj/rf/_g/jjrf_goaqaltjofbhkkx-gntwh8.png)

MAM - сборщик яваскрипта, где тесты и стили выстраиваются в том же порядке, что и код в бандле.

# Фрактальное тестирование: Простота написания

Просто используем компоненты как в реальном коде.

```typescript
const app = new Todomvc({ context })

assert( app.task_ids() , [] )

app.Add().value( 'test title' )
app.Add().done()

assert( app.task_ids() , [ 1 ] )

assert( app.Task_row(1).title() , 'test title' )
assert( app.Task_row(1).completed() , false )

assert( app.Add().value() , '' )
```

# Фрактальное тестирование: Постоянная сложность

![](https://habrastorage.org/webt/75/l1/0y/75l10ygs_woinsfbqkfewdanowm.png)

Каждый уровень добавляет примерно одинаковое число тестов.

# Фрактальное тестирование: Качество

- Тестируются все модули
- Тестируются все взаимосвязи
- На каждом уровне есть все необходимые ручки
- В том числе и вся система в сборе

# Фрактальное тестирование: Простая поддержка

> *Компонентных тестов столько же сколько модульных*
> *исполняются они быстрее чем системные, ибо не требуют поднятия всей системы*
> *а покрытие дают сравнимое с системным*

# Фрактальные тесты: Мой проект

- Сложный web-виджет
- Пилю соло второй год
- 300 тестов
- 0.5 секунд
- При перезагрузке страницы
- Им пользуется мой начальник

*Пишу тесты ибо это нужно прежде всего мне самому. Но стараюсь писать их так, чтобы тратить минимум усилий.*

# Фрактальные тесты: Ограничения

- Монолитная архитектура
- Тяжёлая архитектура
- Кривой тестовый фреймворк

# Фрактальные тесты: Кратчайший путь

*При изменении исполнять лишь зависимые тесты в правильном порядке, а не все подряд.*

# Опыт других людей

- [PiterJS#44: Если нужен тест, пусть он будет интеграционным](https://piterjs.org/#meetup=44/speech=should-test-be-integrational)
- [Is TDD Dead?: My personal practice is that I mock almost nothing.](https://youtu.be/z9quxZsLcfo)

# Что стоит мокать

![Что мокать](https://habrastorage.org/webt/1l/zd/1x/1lzd1xuoykhsh6rpokwjlupi-ii.png)

# Резюме

- Фиксировать надо важное поведение
- А невавжное фиксировать не надо
- Тесты нужны самому же разаботчику
- Модульные тесты бессмысленны
- Системные не масштабируются
- Фрактальные тесты наиболее практичны
- Стоит адаптировать архитектуру под них

*Хватит вращать рожок тестирования, его нужно просто выбросить.*
